@{
    ViewBag.Title = "原材料管理--原材料导入";
    Layout = "~/Views/Shared/_Index.cshtml";
}
<style>
    .uploadify-button {
        border: 1px solid #459830;
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAcCAMAAACgTerKAAAAA3NCSVQICAjb4U/gAAAAVFBMVEVsu1prullquVhpuVZouFVmt1NktlFjtVBhtU5ftExes0pcskhasUZYsERWrkFUrT9SrD1QqztOqjlNqTdLqDVJqDNIpzFGpjBFpS5CpCtDpC1Boyrl/2+uAAAACXBIWXMAAArwAAAK8AFCrDSYAAAAFnRFWHRDcmVhdGlvbiBUaW1lADA0LzEyLzEyiu5yJQAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNAay06AAAABOSURBVEiJvcGHAUAwAADBV6MTJNr+e9ri78BQCCgFVAJqAY2AVkAQ0AnoBQwCRgGTgFnAImAVsAmIAnYBh4BTQBKQBVwCbgGvgEfAJ/gBUt6TqcmCyTYAAAAASUVORK5CYII=");
        background-position: center top;
        background-repeat: no-repeat;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        color: #FFF;
        text-align: center;
        text-shadow: 0 -1px 0 rgba(0,0,0,0.25);
        /*width: 100%;*/
    }
</style>
<div>
    导入模板： <a href="/SteelMember/RawMaterialLibrary/GetTemplet?templetname=原材料导入模板">下载原材料导入模板.xls</a>
</div>
<br />
<form id="form1" name="form1">
    <table>
        <tr>
            <td style="width:400px"><div style="border:1px solid #08dede"><input style="width:100%" @*placeholder="请选择上传excel文件"*@ type="file" name="fileToUpload" onchange="fileChangeu(this)" id="fileToUpload" accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"@*multiple="multiple" onchange="onc()"*@ /></div></td>
            <td><input type="button" class="uploadify-button " onclick="UpladFile()" value="上传" style="margin-left: 20px" /></td>
        </tr>
    </table>
</form>
<script type="text/javascript">
    var Category = request("KeyValue");

    function fileChangeu(target)
    {
        //alert("控制我呀！！");
        var fileSize = 0;
        if (!target.files) {
            var filePath = target.value;
            var fileSystem = new ActiveXObject("Scripting.FileSystemObject");
            var file = fileSystem.GetFile(filePath);
            fileSize = file.Size;
        } else {
            fileSize = target.files[0].size;
        }
        var size = fileSize / 1024;
        if (size > 10485760) {
            dialogMsg("文件不能大于10M",0);
            target.value = "";
            return
        }
        var name = target.value;
        var fileName = name.substring(name.lastIndexOf(".") + 1).toLowerCase();
        if (fileName != "xls" && fileName != "xlsx") {
            dialogMsg("请选择excel格式文件上传！",0);
            target.value = "";
            return
        }
    };

    function UpladFile()
    {
        //获取文件对象
        //var fileObj = $("#fileToUpload").files;
        var fileObj = document.getElementById("fileToUpload").files;
        if (fileObj.length <= 0) {
            dialogMsg("选择原材料模板文件啊！！哥们！！",0)
        }

        var fileController = "/SteelMember/RawMaterialLibrary/SubmitImportFile?category =" + Category;
        var form = new FormData();
        // 可以增加表单数据
        form.append("author", "hooyes");
        // 文件对象
        for (var i = 0; i < fileObj.length; i++)
        {
            form.append("file" + i, fileObj[i]);
            $.ajax({
                type: "post",
                url: fileController,
                data:form,
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data == "2") {
                        btn_upload();
                        dialogClose();
                    } else if (data == "1") {
                            dialogMsg("操作成功!", 0);
                            $.currentIframe().$("#gridTable").trigger("reloadGrid");
                            dialogClose();
                    } else {
                        dialogMsg(data, 0);
                        $.currentIframe().$("#gridTable").trigger("reloadGrid");
                        dialogClose();
                    }
                },
                error: function (e) {
                    dialogMsg(e, 0);
                    $.currentIframe().$("#gridTable").trigger("reloadGrid");
                    dialogClose();
                }
            });
        }
    }
</script>
