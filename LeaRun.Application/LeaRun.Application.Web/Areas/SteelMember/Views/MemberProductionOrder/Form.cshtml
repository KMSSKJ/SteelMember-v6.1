@{;
    ViewBag.Title = "表单页面";
    Layout = "~/Views/Shared/_OrderForm.cshtml";

    var userName = LeaRun.Application.Code.OperatorProvider.Provider.Current().UserName;
}
<script>
    var keyValue = request('keyValue');
    var category = request('category');
    var categoryInput = "";
    $(function () {
        InitialPage();
        GetOrderEntryGrid();
        initControl();
    });
    //初始化页面
    function InitialPage() {
        //resize重设(表格、树形)宽高
        $(window).resize(function (e) {
            window.setTimeout(function () {
                $('#gridTable').setGridWidth(($('.gridPanel').width()));
                $('#gridTable').setGridHeight($(window).height() - 250.5);
            }, 200);
            e.stopPropagation();
        });
    }
    //加载明细表
    function GetOrderEntryGrid() {
        var $grid = $('#gridTable');
        $grid.jqGrid({
            unwritten: false,
            datatype: 'local',
            height: $(window).height() - 250.5,
            autowidth: true,
            colModel: [
                { label: '构件编号[<font face="宋体" color="red">*</font>]', name: "MemberNumbering", align: ' center', width: 180, sortable: false },
                { label: '构件名称', name: "MemberName", align: ' center', width: 150, sortable: false },
                { label: '单位', name: "UnitId", align: ' center', width: 80, sortable: false, align: 'center' },
                { label: '生产数量[<font face="宋体" color="red">*</font>]', name: 'MemberNumber', align: ' center', width: 80, sortable: false },
                { label: '备注', name: "Description", align: ' center', width: 80, sortable: false, align: 'center' },
                //{ label: '单价[<font face="宋体" color="red">*</font>]', name: 'Price', align: ' center', width: 80, sortable: false },
                //{ label: '金额[<font face="宋体" color="red">*</font>]', name: 'PriceAmount', align: ' center', width: 120, sortable: false },
                { label: 'InfoId', name: 'InfoId', align: '', sortable: false, resizable: false, hidden: true },
                { label: 'MemberId', name: 'MemberId', align: '', sortable: false, resizable: false, hidden: true },
                { label: 'MemberDemandId', name: 'MemberDemandId', align: '', sortable: false, resizable: false, hidden: true },
                { label: 'MaxNumber', name: 'MaxNumber', align: '', sortable: false, resizable: false, hidden: true },
            ],
            pager: false,
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            footerrow: false,
            gridComplete: function () {
                ////合计
                //$(this).footerData("set", {
                //    "MemberNumbering": "合计",
                //    "MemberNumber": "<span id='TotalQty'>0</span>",
                //    "Price": "<span id='TotalPrice'>0.00</span>",
                //    "PriceAmount": "<span id='TotalPriceAmount'>0.00</span>",
                //});
            },
            //ondblclick: function (rowid, e) {
            //    var selectedId = $("#gridTable").jqGrid("getGridParam", "selrow");
            //    $("#gridTable").jqGrid("delRowData", selectedId);
            //}
        });
        //默认添加30行 空行
        for (var i = 1; i < 17; i++) {
            var rowdata = {
                MemberNumbering: '<input readonly id="MemberNumbering➩' + i + '" class="editable" type="form-control" style="cursor:pointer" datacol="no" err="构件编号" checkexpession="NotNull" /><input id="MemberNumbering➩' + i + '" type="hidden" />',
                MemberName: '<input id="MemberName➩' + i + '" class="editable disabled center" type="form-control" disabled="disabled" />',
                UnitId: '<input id="UnitId➩' + i + '" class="editable disabled center" type="form-control"disabled="disabled" />',
                MemberNumber: '<input id="MemberNumber➩' + i + '" class="editable center" type="form-control" onkeyup="Conversion(' + i + ')" checkexpession="Number"/>',
                Description: '<input id="Description➩' + i + '" class="editable center" type="form-control" />',
                //Price: '<input id="Price➩' + i + '" class="editable center" type="form-control" onkeyup="Conversion(' + i + ')" datacol="No" err="单价" checkexpession="Double" />',
                //PriceAmount: '<input id="PriceAmount➩' + i + '" class="editable disabled center" type="form-control" datacol="No" err="金额" checkexpession="Double" disabled="disabled"/>',
                InfoId: '<input id="InfoId➩' + i + '" type="form-control" class="editable center" />',
                MemberId: '<input id="MemberId➩' + i + '" type="form-control" class="editable center" />',
                MemberDemandId: '<input id="MemberDemandId➩' + i + '" type="form-control" class="editable center" />',
                MaxNumber: '<input id="MaxNumber➩' + i + '" type="form-control" class="editable center" />',
            }
            $grid.jqGrid('addRowData', i, rowdata);
        };
        ////金额设置居中、设置只能输入金额格式
        //$("#gridTable").find('.decimal').attr('onfocus', 'IsMoney(this.id)');
        //$("#gridTable").find('.center').css('text-align', 'center')
        //$("#gridTable").find('input').attr("disabled", "disabled");
        //for (var i = 1; i < 31; i++) {
        //    $("#gridTable tbody tr:eq("+i+")").find('input').removeAttr('disabled').attr("datacol", "yes");
        //}
        //$("#gridTable").find('.disabled').attr("disabled", "disabled");
        //$('.jqgrid-rownum').attr('title', '双击清空一行');
        //点击物料编码文本框时间，弹出选择物料信息
        $("#gridTable tbody tr").find('td:eq(1)').find('input').click(function () {
            var _category = $("#Category").attr('data-value');
            if (_category == undefined || _category == "" || _category == null) {
                dialogTop("请选择工程名称", "error");
                return false;
            } else if (categoryInput == "请选择工程名称而不是工程分类") {
                dialogMsg("项目名称应选择工程名称而不是工程分类", "error");
                return false;
            }
            var _DepartmentId = $("#DepartmentId").attr('data-value');
            if (_DepartmentId == undefined || _DepartmentId == "" || _DepartmentId == null) {
                dialogMsg('请选择申请部门！', 0);
                return false;
            }

            var _ShippingAddress = $("#ShippingAddress").val();
            if (_ShippingAddress == undefined || _ShippingAddress == "" || _ShippingAddress == null) {
                dialogMsg('请录入收货地址！', 0);
                return false;
            }

            var _ContactPerson = $("#ContactPerson").val();
            if (_ContactPerson == undefined || _ContactPerson == "" || _ContactPerson == null) {
                dialogMsg('请录入联系人！', 0);
                return false;
            }

            var _ContactPersonTel = $("#ContactPersonTel").val();
            if (_ContactPersonTel == undefined || _ContactPersonTel == "" || _ContactPersonTel == null) {
                dialogMsg('请录入联系人电话！', 0);
                return false;
            } else if (_ContactPersonTel.length != 13 && _ContactPersonTel.length != 11) {
                dialogMsg('请录入电话(****-********)或手机格式！', 0);
                return false;
            }
            if ($(this).attr('disabled') == 'disabled') {
                return false;
            }
            var index = $(this).attr('id').split('➩')[1];
            dialogOpen({
                id: 'ItemList',
                title: '选取构件',
                url: '/SteelMember/MemberProductionOrder/ItemList?category=' + _category,
                width: '600px',
                height: '450px',
                callBack: function (iframeId) {
                    top.frames[iframeId].btn_add_();
                }
            });
        });
        //价格信息文本框点击事件
        $("#gridTable").find('.decimal').click(function () {
            $(this).select();
        });
    }
    var array = new Array();
    function IsExistItem(index, code) {
        if (!ArrayExists(array, code)) {
            array[index] = code;
            return false;
        } else {
            return true;
        }
    }

    function HaveExistItem(index, code) {
        if (!ArrayExists(array, code)) {
            return false;
        } else {
            return true;
        }
    }

    function IsExistItemdelete(index, code) {
        for (var i = 0; i < array.length; i++) {
            if (array[i] == code) {
                array.splice(i, 1);
                break;
            }
        }
    }
    //采购订单明细换算+合计
    function Conversion(index) {
        var MaxNumber = Number($("#MaxNumber➩" + index).val());
        var Qty = Number($("#MemberNumber➩" + index).val());//数量

        if (Qty > MaxNumber) {//dialogMsg
            dialogMsg("您的输入不能超过" + MaxNumber, 0)
            $("#MemberNumber➩" + index).val(MaxNumber);
            return
        }
        //var Price = $("#Price➩" + index).val();                            //单价
        //var PriceAmount = $("#PriceAmount➩" + index).val();                //金额
        ////数量*单价=金额
        //$("#PriceAmount➩" + index).val(FormatCurrency(Qty * Price));

        //统计合计
        var TotalQty = 0, TotalPrice = 0.00, TotalPriceAmount = 0.00, TotalPlusPrice = 0.00, TotalCESSAmount = 0.00, TotalPlusPriceAmount = 0.00;
        $("#gridTable tbody tr").each(function (i) {
            var Qty = $(this).find('td:eq(4)').find('input').val();
            if (Qty != "" && Qty != undefined) {
                TotalQty += Number(Qty);
            }
            //var Price = $(this).find('td:eq(5)').find('input').val();
            //if (Price != "" && Qty != undefined) {
            //    TotalPrice += Number(Price);
            //}
            //var PriceAmount = $(this).find('td:eq(6)').find('input').val();
            //if (PriceAmount != "" && Qty != undefined) {
            //    TotalPriceAmount += Number(PriceAmount);
            //}
        });
        $("#TotalQty").text(TotalQty);
        //$("#TotalPrice").text(FormatCurrency(TotalPrice));
        //$("#TotalPriceAmount").text(FormatCurrency(TotalPriceAmount));
    }


    //初始化控件
    function initControl() {
        $("#DepartmentId").ComboBoxTree({
            description: "==请选择==",
        });

        $("#Category").ComboBoxTree({
            param: { Levels: 3 },
            url: "../../SteelMember/SubProject/GetTreeJson",
            description: "==请选择==",
            allowSearch: true,
            click: function (item) {
                if (!item.hasChildren) {
                    categoryInput = "";
                }
                else {
                    categoryInput = "请选择工程名称而不是工程分类";
                    dialogTop("请选择工程名称而不是工程分类", "error");
                    return "false";
                }
            }

        });

        //加载申请部门
        $("#DepartmentId").ComboBoxTree({
            url: "../../BaseManage/Department/GetTreeJson1",
            description: "==请选择==",
            allowSearch: true
        });

        ////工程
        //$("#Category").ComboBoxTree({
        //    param: { Levels: 3 },
        //    url: "../../SteelMember/SubProject/GetTreeJson",
        //    description: "==请选择==",
        //    height: "150px",
        //    click: function (item) {
        //        if (!item.hasChildren) {
        //        }
        //        else {
        //            dialogTop("请选择工程名称而不是工程分类", "error");
        //            return "false";
        //        }
        //    }
        //});
        //获取表单
        if (!!keyValue) {
            $.SetForm({
                url: "../../SteelMember/MemberProductionOrder/GetFormJson",
                param: { keyValue: keyValue },
                success: function (data) {
                    $("#form1").SetWebControls(data.entity);

                    //加载申请部门
                    $("#DepartmentId").ComboBoxTree({
                        url: "../../BaseManage/Department/GetTreeJson?organizeId=" + data.entity.OrganizeId,
                        description: "==请选择==",
                        allowSearch: true
                    });
                    $("#DepartmentId").ComboBoxTreeSetValue(data.entity.DepartmentId);

                    //明细
                    var number = "";
                    var childEntity = data.childEntity;
                    $('#gridTable').find('[role=row]').each(function (i) {
                        var row = childEntity[i - 1];
                        if (row != undefined) {
                            $(this).find('input[id="InfoId➩' + i + '"]').val(row.InfoId);
                            //$(this).find('input[id="OrderId➩' + i + '"]').val(row.OrderId);
                            $(this).find('input[id="MemberId➩' + i + '"]').val(row.MemberId);
                            $(this).find('input[id="MemberDemandId➩' + i + '"]').val(row.MemberDemandId);
                            $(this).find('input[id="MemberNumbering➩' + i + '"]').val(row.MemberNumbering);
                            $(this).find('input[id="MemberName➩' + i + '"]').val(row.MemberName);
                            $(this).find('input[id="UnitId➩' + i + '"]').val(row.UnitId);
                            $(this).find('input[id="MemberNumber➩' + i + '"]').val(row.MemberNumber);
                            $(this).find('input[id="Description➩' + i + '"]').val(row.Description);
                            $.ajax({
                                type: 'post',
                                dataType: "json",
                                url: "/SteelMember/MemberProductionOrder/AddMemberNumber",
                                data: {
                                    category: data.entity.Category,
                                    KeyValue: row.MemberId
                                },
                                cache: false,
                                async: false,
                                success: function (data) {
                                    number = data;
                                }

                            });
                            $(this).find('input[id="MaxNumber➩' + i + '"]').val(Number(number) + Number(row.MemberNumber));
                        }
                    });
                }
            })
        } else {
            $("#Category").ComboBoxTreeSetValue(category);
        }
    }
    //保存表单;
    function AcceptClick() {
        if (!$('#form1').Validform()) {
            return false;
        }
        var postData = $("#form1").GetWebControls(keyValue);
        postData["CategoryName"] = $("#Category").attr('data-text');
        var childEntryJson = [];
        $('#gridTable').find('[role=row]').each(function (i) {
            if (!!$(this).find('input[id="MemberNumbering➩' + i + '"]').val()) {
                childEntryJson.push({
                    InfoId: $(this).find('input[id="InfoId➩' + i + '"]').val(),
                    MemberDemandId: $(this).find('input[id="MemberDemandId➩' + i + '"]').val(),
                    MemberId: $(this).find('input[id="MemberId➩' + i + '"]').val(),
                    ProductionQuantity: $(this).find('input[id="MemberNumber➩' + i + '"]').val(),
                    Description: $(this).find('input[id="Description➩' + i + '"]').val(),
                });
            }
        });
        $.SaveForm({
            url: "../../SteelMember/MemberProductionOrder/SaveForm?keyValue=" + keyValue,
            param: { "strEntity": JSON.stringify(postData), "strChildEntitys": JSON.stringify(childEntryJson) },
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }

</script>
<div class="bills">
    <p style="font-family: 华文楷体; font-size:14pt;text-align:center"> 云南交投建设集团第十工程有限公司</p>
    <p style="font-family: 华文楷体; font-size:20pt;text-align:center"> 构件生产申请单</p>
    <table class="form" style="width:100%;">
        <tr>
            <th class="formTitle">
                分项工程：<font face="宋体" color="red">*</font>
            </th>
            <td class="formValue">
                <div id="Category" type="selectTree" class="ui-select" style="width:100%" isvalid="yes" checkexpession="NotNull"></div>
            </td>
            <th class="formTitle">
                施工单位：<font face="宋体" color="red">*</font>
            </th>
            <td class="formValue">
                @*<div id="OrganizeId" type="selectTree" class="ui-select" style="width: 43%;float:left" isvalid="yes" checkexpession="NotNull"></div>&nbsp;—*@
                <div id="DepartmentId" type="selectTree" class="ui-select" style="width: 100%;float:right" isvalid="yes" checkexpession="NotNull"></div>

            </td>
            <th class="formTitle">
                单号：
            </th>
            <td class="formValue">
                <input readonly id="OrderNumbering" type="text" class="form-control" datacol="yes" err="单号" checkexpession="NotNull" value="@ViewBag.OrderNumbering" style="width: 100%" />
            </td>
        </tr>
        <tr>
            <th class="formTitle">
                收货地址：<font face="宋体" color="red">*</font>
            </th>
            <td class="formValue">
                <input id="ShippingAddress" type="text" class="form-control" style="width:100%" datacol="yes" checkexpession="NotNull" />
            </td>
            <th class="formTitle">
                联系人：<font face="宋体" color="red">*</font>
            </th>
            <td class="formValue">
                <input id="ContactPerson" type="text" class="form-control" style="width:100%" datacol="yes" checkexpession="NotNull" />
            </td>
            <th class="formTitle">
                电话：<font face="宋体" color="red">*</font>
            </th>
            <td class="formValue">
                <input id="ContactPersonTel" type="text" class="form-control" style="width: 100%" datacol="yes" checkexpession="Phone" />
            </td>

        </tr>
        <tr>
            <th class="formTitle">
                生产优先级：
            </th>
            <td class="formValue">
                <select id="Priority" datacol="yes" err="生产优先级" class="form-control" checkexpession="NotNull" style="width: 100%">
                    <option value="0">正常</option>
                    <option value="1">加急</option>
                </select>
            </td>
            <th class="formTitle">
                工程专用：
            </th>
            <td class="formValue">
                <select id="IsDedicated" datacol="yes" err="工程专用" class="form-control" checkexpession="NotNull" style="width: 100%">
                    <option value="0">否</option>
                    <option value="1">是</option>
                </select>
            </td>
            <th class="formTitle">
                申请日期：
            </th>
            <td class="formValue">
                <input id="CreateTime" type="text" class="form-control" datacol="yes" err="制单日期" checkexpession="NotNull" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")" onfocus="WdatePicker({dateFmt: 'yyyy-MM-dd HH:mm:ss' })" style="width: 100%" />
            </td>
        </tr>
    </table>

    <div class="gridPanel printArea">
        <table id="gridTable"></table>
    </div>
</div>
<style>
    .form .formTitle {
        width: 65px;
    }

    /*body {
        margin: 0px;
    }

    .bill {
        margin: 10px;
    }

        .bill th {
            text-align: right;
            color: #222222;
        }

        .bill tr {
            margin-bottom: 10px;
        }

        .bill input {
            text-align: left;
            border-width: 0px;
            border-bottom: 1px solid #e2dada;
        }

    .bills {
        overflow: hidden;
        border-radius: 0px;
        position: relative;
        background: #FFFFFF;
        border: 0px solid rgb(204, 204, 204);
        box-shadow: none;
        padding: 0px;
    }

    .ui-widget-content {
        border-left: 0px;
        border-right: 0px;
        border-bottom: 0px;
    }*/
</style>
