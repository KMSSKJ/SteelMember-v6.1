@{
    ViewBag.Title = "材料用量";
    Layout = "~/Views/Shared/_Form.cshtml";
}
<script>
    var TreeId;
    var MemberId = request('MemberId');
    var RawMaterial = request('RawMaterialId');
    $(function () {
        initControl();
    })
    var dataJson = top.Form.RawMaterialJson;

    //初始化控件
    function initControl() {
        //材料类型
        $("#TreeName").ComboBox({
            param: { EnCode: "RawMaterialType" },
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            description: "==请选择==",
            id: "ItemDetailId",
            text: "ItemName",
            height: "200px"
        }).bind("change", function () {
            TreeId = $(this).attr('data-value');//$("#Category").attr('data-text'),
            //加载材料
            $("#RawMaterialId").ComboBox({
                url: '../../SteelMember/MemberLibrary/GetRawMaterialJsonList',
                param: { KeyValue: TreeId },
                id: "RawMaterialId",
                text: "RawMaterialModel",
                description: "==请选择==",
                height: "200px",
            });
        });


        //获取表单
        if (!!RawMaterial) {
            var RawMaterialName = "";
            var RawMaterialModel = "";
            $.each(dataJson, function (i) {
                var row = dataJson[i];
                if (row.RawMaterialId == RawMaterial) {
                    RawMaterialName = row.RawMaterialName;
                    RawMaterialModel = row.RawMaterialModel;
                    $("#form1").SetWebControls(row);
                    $("#TreeName").ComboBoxSetValue(row.Category);
                    //$("#RawMaterialId").ComboBoxSetValue(row.RawMaterialId);
                }
            });

            $("#RawMaterialId").ComboBox({
                description: RawMaterialName + "(" + RawMaterialModel + ")",
                height: "200px",
            });

        } else {
            //$("#MemberId").val(MemberId);
            $("#RawMaterialId").ComboBox({
                description: "==请选择==",
                height: "200px",
            });
        }
    }

    //验证材料不能重复
    $._ExistField = function (controlId, url, param) {
        var TreeName = $("#TreeName").attr('data-value');
        var RawMaterialId = $("#RawMaterialId").attr('data-value');
        if (RawMaterialId == "==请选择==" || TreeName == undefined || TreeName == "" || TreeName == '' || TreeName == null) {
            return false;
        }
        if (MemberId == "") {
            MemberId = "M";
        }
        var data = {
            MemberId: MemberId,
            TreeName: TreeName
        };
        data["RawMaterialId"] = RawMaterialId;
        var options = $.extend(data, param);
        if ($.currentIframe("Form").ExistRawMaterial(RawMaterialId)) {
            ValidationMessage($("#RawMaterialId"), '数据表中已存在,请重新输入');
            $("#RawMaterialId").attr('fieldexist', 'yes');
        }
        else {
            $.ajax({
                url: url,
                data: options,
                type: "get",
                dataType: "text",
                async: false,
                success: function (data) {
                    if (data.toLocaleLowerCase() == 'false') {
                        ValidationMessage($("#RawMaterialId"), '数据库中已存在,请重新输入');
                        $("#RawMaterialId").attr('fieldexist', 'yes');
                    } else {
                        $("#RawMaterialId").attr('fieldexist', 'no');
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    dialogMsg(errorThrown, -1);
                }
            })
        }
    }

    //保存表单
    function AcceptClick(callback) {

        if (!$('#form1').Validform()) {
            return false;
        }

        var data = $("#form1").GetWebControls(RawMaterial);
        data["Category"] = $("#TreeName").attr('data-value');
     
        callback(data);
        dialogClose();
    }

</script>
<div style="margin-left: 10px; margin-top: 30px; margin-right: 30px;">
    <input id="MemberMaterialId" type="hidden" />
    @*<input id="RawMaterialId" type="hidden" />*@
    <input id="MemberId" type="hidden" />
    <input id="Category" type="hidden" />
    <table class="form">
        <tr>
            <td class="formTitle">
                材料类型<font face="宋体" color="red">*</font>
            </td>
            <td class="formValue">
                <div id="TreeName" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull"></div>
            </td>
        </tr>

        <tr>
            <td class="formTitle">
                材料规格或型号<font face="宋体" color="red">*</font>
            </td>
            <td class="formValue">
                @*onblur="$._ExistField(this.id,'/SteelMember/RawMaterialLibrary/ExistFullName')"*@
                <div id="RawMaterialId" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull"></div>
            </td>
        </tr>
        <tr>
            <td class="formTitle">
                用量<font face="宋体" color="red">*</font>
            </td>
            <td class="formValue">
                <input id="RawMaterialNumber" type="text" onmouseout="$._ExistField(this.id,'../../SteelMember/MemberLibrary/ExistMemberMaterial')" class="form-control" placeholder="请输入用量" isvalid="yes" checkexpession="ExceedZero" />
            </td>
        </tr>
    </table>
</div>
